name: ðŸ” Review Coding Challenges

on:
  workflow_dispatch:
    inputs:
      mark_all_for_review:
        description: 'Mark all challenges for review first'
        required: false
        type: boolean
        default: false
      batch_size:
        description: 'Number of challenges to review'
        required: false
        type: number
        default: 50
      challenge_id:
        description: 'Review specific challenge ID (optional)'
        required: false
        type: string
  schedule:
    # Run weekly on Sundays at 3 AM UTC
    - cron: '0 3 * * 0'

jobs:
  review-challenges:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: npm install dotenv @libsql/client

      - name: Review coding challenges
        id: review
        run: node script/review-challenges-bot.js
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          BATCH_SIZE: ${{ inputs.batch_size || 50 }}
          CHALLENGE_ID: ${{ inputs.challenge_id || '' }}
          MARK_ALL_FOR_REVIEW: ${{ inputs.mark_all_for_review || 'false' }}

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ” Coding Challenge Review" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Reviewed | ${{ steps.review.outputs.reviewed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Approved | ${{ steps.review.outputs.approved }} |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ Needs Fix | ${{ steps.review.outputs.needs_fix }} |" >> $GITHUB_STEP_SUMMARY
          echo "| â­ï¸ Skipped | ${{ steps.review.outputs.skipped }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Overall Status" >> $GITHUB_STEP_SUMMARY
          echo "| Status | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Pending | ${{ steps.review.outputs.pending }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Total | ${{ steps.review.outputs.total }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
