name: ðŸ¤– Content Pipeline

# Unified content generation and quality assurance pipeline
# Runs: Creator â†’ Analysis â†’ Verifier â†’ Processor â†’ Blog Generator
# Schedule: Daily at 2:00 AM UTC
#
# Pipeline Flow:
# 1. Creator Bot: Generates new questions
# 2. Analysis Bot: Detects quality issues, channel mismatches, enrichment opportunities
# 3. Verifier Bot: Deep quality validation (legacy, runs in parallel)
# 4. Processor Bot: Fixes all detected issues from work queue
# 5. Blog Generator: Creates blog content from questions
# 6. Monitor Update: Updates bot activity dashboard

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      stage:
        description: 'Which stage to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - creator
          - analysis
          - verifier
          - processor
          - blog-generator
      count:
        description: 'Number of items to process'
        required: false
        default: '5'
      analysis_focus:
        description: 'Analysis focus area'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - quality
          - channels
          - enrichment
          - voice
          - duplicates

jobs:
  creator:
    name: ðŸ“ Creator Bot
    if: github.event_name == 'schedule' || inputs.stage == 'all' || inputs.stage == 'creator'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-bot
      - name: Run Creator Bot
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          QDRANT_URL: ${{ secrets.QDRANT_URL }}
          QDRANT_API_KEY: ${{ secrets.QDRANT_API_KEY }}
          OLLAMA_URL: ${{ secrets.OLLAMA_URL }}
          COUNT: ${{ inputs.count || '5' }}
        run: node script/bots/creator-bot.js

  analysis:
    name: ðŸ” Analysis Bot
    if: always() && (github.event_name == 'schedule' || inputs.stage == 'all' || inputs.stage == 'analysis')
    needs: [creator]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-bot
      - name: Run Analysis Bot
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          QDRANT_URL: ${{ secrets.QDRANT_URL }}
          QDRANT_API_KEY: ${{ secrets.QDRANT_API_KEY }}
          OLLAMA_URL: ${{ secrets.OLLAMA_URL }}
        run: |
          FOCUS="${{ inputs.analysis_focus || 'all' }}"
          LIMIT="${{ inputs.count || '100' }}"
          
          if [ "$FOCUS" = "all" ]; then
            # Run comprehensive analysis
            echo "ðŸ” Running comprehensive analysis..."
            node script/bots/analysis-bot.js --limit=$LIMIT
          else
            # Run focused analysis
            echo "ðŸ” Running focused analysis: $FOCUS"
            node script/bots/analysis-bot.js --focus=$FOCUS --limit=$LIMIT
          fi

  verifier:
    name: âœ… Verifier Bot
    if: always() && (github.event_name == 'schedule' || inputs.stage == 'all' || inputs.stage == 'verifier')
    needs: [analysis]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-bot
      - name: Run Verifier Bot
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          QDRANT_URL: ${{ secrets.QDRANT_URL }}
          QDRANT_API_KEY: ${{ secrets.QDRANT_API_KEY }}
          OLLAMA_URL: ${{ secrets.OLLAMA_URL }}
          MODE: scan
          LIMIT: ${{ inputs.count || '10' }}
        run: node script/bots/verifier-bot.js

  processor:
    name: âš™ï¸ Processor Bot
    if: always() && (github.event_name == 'schedule' || inputs.stage == 'all' || inputs.stage == 'processor')
    needs: [verifier]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-bot
      - name: Run Processor Bot
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          QDRANT_URL: ${{ secrets.QDRANT_URL }}
          QDRANT_API_KEY: ${{ secrets.QDRANT_API_KEY }}
          OLLAMA_URL: ${{ secrets.OLLAMA_URL }}
          MAX_ITEMS: ${{ inputs.count || '10' }}
        run: node script/bots/processor-bot.js

  blog-generator:
    name: ðŸ“° Blog Generator
    if: always() && (github.event_name == 'schedule' || inputs.stage == 'all' || inputs.stage == 'blog-generator')
    needs: [processor]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-bot
      - name: Generate Blog Content
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          QDRANT_URL: ${{ secrets.QDRANT_URL }}
          QDRANT_API_KEY: ${{ secrets.QDRANT_API_KEY }}
          OLLAMA_URL: ${{ secrets.OLLAMA_URL }}
        run: node script/generate-blog.js

  update-monitor:
    name: ðŸ“Š Update Monitor
    needs: [blog-generator]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node-pnpm
      - name: Generate monitor data
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
        run: node script/fetch-bot-monitor-data.js
      - name: Commit and push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -f client/public/data/bot-monitor.json
          git diff --staged --quiet || git commit -m "Update bot monitor data [skip ci]"
          git push

  summary:
    name: ðŸ“‹ Summary
    needs: [creator, analysis, verifier, processor, blog-generator, update-monitor]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸ¤– Content Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ Creator | ${{ needs.creator.result == 'success' && 'âœ…' || needs.creator.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Analysis | ${{ needs.analysis.result == 'success' && 'âœ…' || needs.analysis.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Verifier | ${{ needs.verifier.result == 'success' && 'âœ…' || needs.verifier.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| âš™ï¸ Processor | ${{ needs.processor.result == 'success' && 'âœ…' || needs.processor.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“° Blog Generator | ${{ needs.blog-generator.result == 'success' && 'âœ…' || needs.blog-generator.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“Š Monitor | ${{ needs.update-monitor.result == 'success' && 'âœ…' || needs.update-monitor.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
