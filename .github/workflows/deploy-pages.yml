name: Deploy to GitHub Pages

on:
  push:
    branches: [ main, production ]
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ============================================
  # TEST (runs on main branch only)
  # ============================================
  test:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
          
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
          
      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
            
      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile
        
      - name: Fetch questions from Turso
        run: node script/fetch-questions-for-build.js
        env:
          TURSO_DATABASE_URL_RO: ${{ secrets.TURSO_DATABASE_URL_RO }}
          TURSO_AUTH_TOKEN_RO: ${{ secrets.TURSO_AUTH_TOKEN_RO }}
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
        
      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium
        
      - name: Build application
        run: pnpm run build

      - name: Build Pagefind search index
        run: pnpm run build:pagefind
        
      - name: Run E2E tests
        run: pnpm exec playwright test --project=chromium
        env:
          CI: 'true'
        
      - name: Upload test results on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-results
          path: test-results/
          retention-days: 3

  # ============================================
  # STAGING DEPLOYMENT (main branch only)
  # ============================================
  deploy-staging:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: test
    environment:
      name: staging
      url: https://stage-open-interview.github.io
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 10
        
    - name: Get pnpm store directory
      shell: bash
      run: |
        echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
        
    - name: Setup pnpm cache
      uses: actions/cache@v4
      with:
        path: ${{ env.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/package.json') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-
        
    - name: Install dependencies
      run: pnpm install --no-frozen-lockfile
      
    - name: Fetch questions from Turso
      run: node script/fetch-questions-for-build.js
      env:
        TURSO_DATABASE_URL_RO: ${{ secrets.TURSO_DATABASE_URL_RO }}
        TURSO_AUTH_TOKEN_RO: ${{ secrets.TURSO_AUTH_TOKEN_RO }}
        TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
        TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
      
    - name: Generate SEO files
      run: node script/generate-sitemap.js
      
    - name: Build for staging
      run: pnpm run build
      env:
        VITE_STAGING: 'true'

    - name: Build Pagefind search index
      run: pnpm run build:pagefind
      
    - name: Deploy to Staging (GitHub Pages)
      env:
        DEPLOY_REPO: open-interview-stage/stage-open-interview.github.io
        DEPLOY_BRANCH: main
        GIT_USER_NAME: ${{ github.actor }}
        GIT_USER_EMAIL: ${{ github.actor }}@users.noreply.github.com
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
      run: |
        git config --global user.name "$GIT_USER_NAME"
        git config --global user.email "$GIT_USER_EMAIL"
        
        BUILD_DIR="dist/public"
        
        git clone --depth 1 "https://x-access-token:${GITHUB_TOKEN}@github.com/${DEPLOY_REPO}.git" staging-deploy
        
        cd staging-deploy
        find . -maxdepth 1 ! -name '.git' ! -name '.' -exec rm -rf {} +
        cd ..
        
        cp -r ${BUILD_DIR}/* staging-deploy/
        touch staging-deploy/.nojekyll
        
        cd staging-deploy
        git add -A
        git diff --staged --quiet || git commit -m "Deploy to staging: ${{ github.sha }}"
        git push origin ${DEPLOY_BRANCH}
        
    - name: Staging Deployment Summary
      run: |
        echo "## ðŸš€ Staging Deployment Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Staging URL:** https://stage-open-interview.github.io" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. Review the staging deployment" >> $GITHUB_STEP_SUMMARY
        echo "2. Run 'Promote to Production' workflow to deploy to production" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # PRODUCTION DEPLOYMENT (production branch only)
  # ============================================
  deploy-production:
    if: github.ref == 'refs/heads/production'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://open-interview.github.io
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 10
        
    - name: Get pnpm store directory
      shell: bash
      run: |
        echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
        
    - name: Setup pnpm cache
      uses: actions/cache@v4
      with:
        path: ${{ env.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/package.json') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-
        
    - name: Install dependencies
      run: pnpm install --no-frozen-lockfile
      
    - name: Fetch questions from Turso
      run: node script/fetch-questions-for-build.js
      env:
        TURSO_DATABASE_URL_RO: ${{ secrets.TURSO_DATABASE_URL_RO }}
        TURSO_AUTH_TOKEN_RO: ${{ secrets.TURSO_AUTH_TOKEN_RO }}
        TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
        TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
      
    - name: Generate SEO files
      run: node script/generate-sitemap.js
      
    - name: Build for production
      run: pnpm run build

    - name: Build Pagefind search index
      run: pnpm run build:pagefind
      
    - name: Deploy to Production (GitHub Pages)
      env:
        DEPLOY_REPO: open-interview/open-interview.github.io
        DEPLOY_BRANCH: gh-pages
        GIT_USER_NAME: ${{ github.actor }}
        GIT_USER_EMAIL: ${{ github.actor }}@users.noreply.github.com
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
      run: |
        git config --global user.name "$GIT_USER_NAME"
        git config --global user.email "$GIT_USER_EMAIL"
        pnpm run deploy:pages
        
    - name: Ping search engines
      run: node script/ping-search-engines.js
      continue-on-error: true
        
    - name: Production Deployment Summary
      if: always()
      run: |
        echo "## âœ… Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Production URL:** https://open-interview.github.io" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
