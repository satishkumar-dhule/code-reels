name: ðŸ§¹ Daily Maintenance

# Runs daily to clear old "NEW" flags and perform other maintenance tasks

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  maintenance:
    name: ðŸ§¹ Run Maintenance Tasks
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      
      - uses: ./.github/actions/setup-bot
      
      - name: Run migrations (if needed)
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
        run: |
          echo "ðŸ”„ Running database migrations..."
          node script/migrations/add-is-new-column.js || echo "âš ï¸  Migration skipped or already applied"
      
      - name: Clear old NEW flags
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
        run: |
          echo "ðŸ§¹ Clearing NEW flags for questions older than 7 days..."
          node script/maintenance/clear-old-new-flags.js
      
      - name: Generate Summary
        if: always()
        run: |
          echo "## ðŸ§¹ Daily Maintenance Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tasks completed:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Cleared old NEW flags" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
