name: Promote to Production

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "promote" to confirm promotion to production'
        required: true
        type: string

concurrency:
  group: promote-production
  cancel-in-progress: false

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Validate confirmation
        if: github.event.inputs.confirm != 'promote'
        run: |
          echo "❌ Confirmation failed. You must type 'promote' to proceed."
          exit 1

  promote:
    runs-on: ubuntu-latest
    needs: validate
    environment:
      name: production
      url: https://open-interview.github.io
    
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}
          
      - name: Get current commits
        id: commits
        run: |
          MAIN_SHA=$(git rev-parse HEAD)
          echo "main_sha=${MAIN_SHA}" >> $GITHUB_OUTPUT
          echo "main_short=${MAIN_SHA:0:7}" >> $GITHUB_OUTPUT
          
          # Check if production branch exists
          if git ls-remote --heads origin production | grep -q production; then
            git fetch origin production
            PROD_SHA=$(git rev-parse origin/production)
            echo "prod_sha=${PROD_SHA}" >> $GITHUB_OUTPUT
            echo "prod_exists=true" >> $GITHUB_OUTPUT
          else
            echo "prod_exists=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Show changes to be promoted
        if: steps.commits.outputs.prod_exists == 'true'
        run: |
          echo "## Changes being promoted to production:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**From:** main (${{ steps.commits.outputs.main_short }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Commits:" >> $GITHUB_STEP_SUMMARY
          git log --oneline origin/production..HEAD | head -20 >> $GITHUB_STEP_SUMMARY
          
      - name: Configure Git
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          
      - name: Sync main to production branch
        run: |
          # Create or update production branch to match main
          git checkout -B production
          git push origin production --force
          
      - name: Promotion Summary
        run: |
          echo "## ✅ Promotion Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Main branch** has been synced to **production branch**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ steps.commits.outputs.main_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Promoted by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The production deployment workflow will now run automatically." >> $GITHUB_STEP_SUMMARY
