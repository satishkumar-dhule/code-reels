name: ðŸ“Š Ranker Bot

on:
  schedule:
    # Run daily at 4 AM UTC
    - cron: '0 4 * * *'
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'Number of questions to score'
        required: false
        default: '100'

jobs:
  score-questions:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Install OpenCode CLI
        run: |
          curl -fsSL https://opencode.ai/install.sh | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH
          
      - name: Run Relevance Bot
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          BATCH_SIZE: ${{ github.event.inputs.batch_size || '100' }}
          CI: 'true'
        run: node script/relevance-bot.js

      - name: Trigger deploy
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deploy-pages.yml',
              ref: 'main'
            });
            console.log('Triggered deploy workflow');
        
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“Š Ranker Bot" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Interview Likelihood Scoring" >> $GITHUB_STEP_SUMMARY
          echo "- Processed: ${{ env.processed || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Scored: ${{ env.scored || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Score Distribution" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒŸ Excellent (80-100): ${{ env.excellent || '0' }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Good (60-79): ${{ env.good || '0' }}" >> $GITHUB_STEP_SUMMARY
          echo "- âš ï¸ Fair (40-59): ${{ env.fair || '0' }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”´ Needs Review (<40): ${{ env.needs_review || '0' }}" >> $GITHUB_STEP_SUMMARY
