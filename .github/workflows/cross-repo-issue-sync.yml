name: ðŸ”— Cross-Repo Issue Sync

# Fetches and processes issues from open-interview.github.io
# Runs from this repo (open-interview) using GH_TOKEN to access the other repo

on:
  schedule:
    - cron: '*/15 * * * *'
  
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'Source repository (owner/repo)'
        required: false
        default: 'open-interview/open-interview.github.io'
      max_issues:
        description: 'Maximum issues to process'
        required: false
        default: '10'

env:
  SOURCE_REPO: ${{ inputs.source_repo || 'open-interview/open-interview.github.io' }}

jobs:
  process-external-issues:
    name: ðŸ”„ Process External Issues
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      
      - uses: ./.github/actions/setup-bot
      
      - name: Fetch and process issues from external repo
        id: process
        uses: actions/github-script@v7
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const sourceRepo = process.env.SOURCE_REPO;
            const [sourceOwner, sourceRepoName] = sourceRepo.split('/');
            const maxIssues = parseInt('${{ inputs.max_issues || '10' }}');
            
            console.log(`ðŸ“¥ Fetching issues from ${sourceRepo}...`);
            
            // Fetch open issues with bot:processor label from source repo
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: sourceOwner,
              repo: sourceRepoName,
              labels: 'bot:processor',
              state: 'open',
              per_page: maxIssues,
              sort: 'created',
              direction: 'desc'
            });
            
            console.log(`Found ${issues.length} issues to process`);
            
            // Filter out already processing or completed issues
            const toProcess = issues.filter(issue => {
              const labels = issue.labels.map(l => l.name);
              return !labels.includes('bot:in-progress') && !labels.includes('bot:completed');
            });
            
            console.log(`${toProcess.length} issues need processing`);
            
            const processed = [];
            
            for (const issue of toProcess) {
              console.log(`\nðŸ“‹ Processing issue #${issue.number}: ${issue.title}`);
              
              try {
                // Mark as in-progress
                await github.rest.issues.addLabels({
                  owner: sourceOwner,
                  repo: sourceRepoName,
                  issue_number: issue.number,
                  labels: ['bot:in-progress']
                });
                
                // Store issue info for the processor bot
                core.exportVariable(`ISSUE_${issue.number}_BODY`, issue.body);
                core.exportVariable(`ISSUE_${issue.number}_TITLE`, issue.title);
                
                processed.push({
                  number: issue.number,
                  title: issue.title,
                  body: issue.body,
                  url: issue.html_url
                });
                
              } catch (error) {
                console.log(`âŒ Error processing issue #${issue.number}: ${error.message}`);
              }
            }
            
            core.setOutput('processed_count', processed.length.toString());
            core.setOutput('issues', JSON.stringify(processed));
            
            // Write issues to file for processor bot
            const fs = require('fs');
            fs.writeFileSync('/tmp/external-issues.json', JSON.stringify(processed, null, 2));
            
            console.log(`\nâœ… Prepared ${processed.length} issues for processing`);

      - name: Run Processor Bot on External Issues
        if: steps.process.outputs.processed_count != '0'
        env:
          TURSO_DATABASE_URL: ${{ secrets.TURSO_DATABASE_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          QDRANT_URL: ${{ secrets.QDRANT_URL }}
          QDRANT_API_KEY: ${{ secrets.QDRANT_API_KEY }}
          OLLAMA_URL: ${{ secrets.OLLAMA_URL }}
          EXTERNAL_ISSUES_FILE: /tmp/external-issues.json
        run: |
          echo "ðŸ”„ Running processor bot on external issues..."
          node script/bots/processor-bot.js --external-issues

      - name: Update source repo issues
        if: always() && steps.process.outputs.processed_count != '0'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const sourceRepo = process.env.SOURCE_REPO;
            const [sourceOwner, sourceRepoName] = sourceRepo.split('/');
            const issues = JSON.parse('${{ steps.process.outputs.issues }}');
            
            for (const issue of issues) {
              try {
                // Remove in-progress, add completed
                await github.rest.issues.removeLabel({
                  owner: sourceOwner,
                  repo: sourceRepoName,
                  issue_number: issue.number,
                  name: 'bot:in-progress'
                }).catch(() => {});
                
                await github.rest.issues.addLabels({
                  owner: sourceOwner,
                  repo: sourceRepoName,
                  issue_number: issue.number,
                  labels: ['bot:completed']
                });
                
                // Add completion comment
                await github.rest.issues.createComment({
                  owner: sourceOwner,
                  repo: sourceRepoName,
                  issue_number: issue.number,
                  body: `âœ… **Processing Complete**\n\nThis issue has been processed by the main repository.\n\nðŸ”— Processed by: [open-interview](https://github.com/open-interview/open-interview)`
                });
                
                // Close the issue
                await github.rest.issues.update({
                  owner: sourceOwner,
                  repo: sourceRepoName,
                  issue_number: issue.number,
                  state: 'closed'
                });
                
                console.log(`âœ… Updated issue #${issue.number}`);
              } catch (error) {
                console.log(`âŒ Error updating issue #${issue.number}: ${error.message}`);
              }
            }

      - name: Generate Summary
        if: always()
        run: |
          echo "## ðŸ”— Cross-Repo Issue Processing" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Source:** ${{ env.SOURCE_REPO }}" >> $GITHUB_STEP_SUMMARY
          echo "**Processed:** ${{ steps.process.outputs.processed_count || '0' }} issues" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
